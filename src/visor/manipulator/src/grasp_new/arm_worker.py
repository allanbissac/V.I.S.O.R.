#!/usr/bin/env python3
# æŒ‡å®šè§£é‡Šå™¨è·¯å¾„ï¼Œå‘Šè¯‰ç³»ç»Ÿä½¿ç”¨ python3 æ¥æ‰§è¡Œæ­¤è„šæœ¬

# --- å¯¼å…¥å¿…è¦çš„åº“ ---
import time  # ç”¨äºå¤„ç†æ—¶é—´å»¶è¿Ÿ (sleep)
import math  # ç”¨äºæ•°å­¦è®¡ç®— (å¦‚è®¡ç®—è·ç¦» sqrt)
import rclpy  # ROS2 çš„ Python å®¢æˆ·ç«¯åº“
from rclpy.node import Node  # ä» rclpy å¯¼å…¥ Node åŸºç±»ï¼Œç”¨äºåˆ›å»ºèŠ‚ç‚¹
from std_msgs.msg import String  # å¯¼å…¥æ ‡å‡†çš„ String æ¶ˆæ¯ç±»å‹ï¼Œç”¨äºæ¥æ”¶æŒ‡ä»¤
from pymycobot import MyCobot280  # å¯¼å…¥å¤§è±¡æœºå™¨äºº MyCobot 280 çš„æ§åˆ¶åº“

class ArmWorker(Node):
    """
    å®šä¹‰ ArmWorker ç±»ï¼Œç»§æ‰¿è‡ª ROS2 çš„ Node ç±»ã€‚
    è¿™ä¸ªç±»è´Ÿè´£æ§åˆ¶æœºæ¢°è‡‚çš„è¿åŠ¨ã€å¤¹çˆªå¼€åˆä»¥åŠå¤„ç† ROS æŒ‡ä»¤ã€‚
    """
    def __init__(self):
        # è°ƒç”¨çˆ¶ç±» (Node) çš„åˆå§‹åŒ–å‡½æ•°ï¼Œå°†èŠ‚ç‚¹å‘½åä¸º 'arm_worker_node'
        super().__init__('arm_worker_node')
        
        # --- 1. ç¡¬ä»¶è¿æ¥é…ç½® ---
        # è®¾ç½®ä¸²å£ç«¯å£ï¼Œæ ‘è“æ´¾ç‰ˆ MyCobot é»˜è®¤è¿æ¥åœ¨ /dev/ttyAMA0
        self.port = '/dev/ttyAMA0'
        # è®¾ç½®æ³¢ç‰¹ç‡ï¼ŒMyCobot 280 é»˜è®¤æ³¢ç‰¹ç‡ä¸º 1000000
        self.baud = 1000000
        
        try:
            # å°è¯•å®ä¾‹åŒ– MyCobot280 å¯¹è±¡ï¼Œå»ºç«‹ä¸æœºæ¢°è‡‚çš„ä¸²å£é€šä¿¡
            self.mc = MyCobot280(self.port, self.baud)
            
            # --- ä¸Šç”µå¹¶ç­‰å¾… ---
            # å‘é€ä¸Šç”µæŒ‡ä»¤ï¼Œè§£é”æœºæ¢°è‡‚ä¼ºæœç”µæœº
            self.mc.power_on()
            # ç­‰å¾… 0.5 ç§’ï¼Œç¡®ä¿æœºæ¢°è‡‚æœ‰è¶³å¤Ÿæ—¶é—´å®Œæˆä¸Šç”µåˆå§‹åŒ–
            time.sleep(0.5)
            
            # åœ¨ç»ˆç«¯æ‰“å°æ—¥å¿—ï¼Œæç¤ºè¿æ¥æˆåŠŸ
            self.get_logger().info(f"âœ… æœºæ¢°è‡‚è¿æ¥æˆåŠŸ: {self.port}")
            
            # è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°åˆå§‹åŒ–å¤¹çˆª (å¼ å¼€å¤¹çˆª)
            self.init_gripper()
            
        except Exception as e:
            # å¦‚æœè¿æ¥æˆ–åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ (å¦‚ä¸²å£æœªæ‰¾åˆ°)ï¼Œæ•è·å¼‚å¸¸
            self.get_logger().error(f"âŒ è¿æ¥æˆ–åˆå§‹åŒ–å¤±è´¥: {e}")
            # å°† self.mc è®¾ä¸º Noneï¼Œä½œä¸ºåç»­åˆ¤æ–­æœºæ¢°è‡‚æ˜¯å¦å¯ç”¨çš„æ ‡å¿—
            self.mc = None

        # --- 2. å®šä¹‰åˆå§‹ä½ç½® (Home) ---
        # å®šä¹‰æœºæ¢°è‡‚çš„å½’ä½å§¿æ€ï¼Œè¿™é‡Œæ˜¯ 6 ä¸ªå…³èŠ‚è§’åº¦å‡ä¸º 0
        self.home_angles = [0, 0, 0, 0, 0, 0] 

        # --- 3. è®¢é˜…æŒ‡ä»¤è¯é¢˜ ---
        self.subscription = self.create_subscription(
            String, 'arm_command', self.command_callback, 10
        )
        
        # çŠ¶æ€æ ‡å¿—ä½ï¼šæ ‡è®°æœºæ¢°è‡‚å½“å‰æ˜¯å¦æ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œé˜²æ­¢æŒ‡ä»¤å†²çª
        self.is_busy = False
        # çŠ¶æ€æ ‡å¿—ä½ï¼šæ ‡è®°å¤¹çˆªå½“å‰æ˜¯å¦æŒæœ‰ç‰©ä½“
        self.has_object = False
        
        # èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œå…ˆæ§åˆ¶æœºæ¢°è‡‚å›åˆ°åˆå§‹ä½ç½®
        self.go_home()

        # =========================================================
        # --- [æ–°å¢éƒ¨åˆ†] åˆå§‹åŒ–å¤¹çˆªç›‘æ§å®šæ—¶å™¨ ---
        # =========================================================
        # åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œå‘¨æœŸä¸º 1.0 ç§’
        # åªè¦èŠ‚ç‚¹åœ¨è¿è¡Œï¼Œå®ƒå°±ä¼šå‘¨æœŸæ€§è°ƒç”¨ self.monitor_gripper
        self.timer = self.create_timer(1.0, self.monitor_gripper)
        self.get_logger().info("ğŸ›¡ï¸ æ‰è½æ£€æµ‹æ¨¡å—å·²æ¿€æ´»")
        # =========================================================

    # =========================================================
    # --- [æ–°å¢éƒ¨åˆ†] å¤¹çˆªè§’åº¦ç›‘æµ‹é€»è¾‘ ---
    # =========================================================
    def monitor_gripper(self):
        """
        å®šæ—¶ä»»åŠ¡ï¼šæ£€æŸ¥ç‰©ä½“æ˜¯å¦æ‰è½
        é€»è¾‘ï¼šåªæœ‰åœ¨ç³»ç»Ÿè®¤ä¸º'æ‰‹é‡Œæœ‰ç‰©ä½“'(has_object=True)ä¸”'ä¸å¿™'(is_busy=False)æ—¶æ‰æ£€æµ‹
        """
        # 1. åªæœ‰å½“ç¨‹åºé€»è¾‘è®¤ä¸ºæ‰‹é‡Œæ‹¿ç€ä¸œè¥¿æ—¶ï¼Œæ‰éœ€è¦æ£€æµ‹æ‰è½
        if self.has_object and self.mc:
            try:
                # è¯»å–å½“å‰å¤¹çˆªæ•°å€¼ (0-100)
                current_value = self.mc.get_gripper_value()
                self.get_logger().info(f"DEBUG: å½“å‰å¤¹çˆªå€¼ {current_value}")#debug
                
                # [åˆ¤æ–­é€»è¾‘] å¦‚æœæ•°å€¼å°äº 10ï¼Œè¯´æ˜å¤¹çˆªå‡ ä¹å®Œå…¨é—­åˆäº†ï¼Œæ„å‘³ç€ä¸­é—´æ²¡æœ‰ç‰©ä½“
                if current_value < 30:
                    self.get_logger().warn(f"ğŸš¨ è­¦æŠ¥ï¼šç‰©ä½“æ‰è½ï¼(æ£€æµ‹æ•°å€¼: {current_value})")
                    
                    # [çŠ¶æ€é‡ç½®]
                    # å°† has_object è®¾ä¸º Falseã€‚
                    # è¿™æ ·åšçš„æ•ˆæœæ˜¯ï¼š
                    # 1. ä¸‹ä¸€æ¬¡å®šæ—¶å™¨ä¸ä¼šå†è¿›å…¥è¿™ä¸ª if (å®ç°å•æ¬¡è­¦æŠ¥)
                    # 2. perform_pick å‡½æ•°å¼€å¤´çš„æ£€æŸ¥ä¼šé€šè¿‡ï¼Œå…è®¸ç”¨æˆ·é‡æ–°å‘é€ pick æŒ‡ä»¤
                    self.has_object = False
                    self.get_logger().warn("ğŸ”„ çŠ¶æ€å·²é‡ç½®ï¼Œç­‰å¾…æ¥æ”¶æ–°çš„ Pick æŒ‡ä»¤...")
                    
            except Exception as e:
                # é˜²æ­¢è¯»å–å¤±è´¥å¯¼è‡´èŠ‚ç‚¹å´©æºƒ
                self.get_logger().error(f"ç›‘æ§è¯»å–å¤±è´¥: {e}")
    # =========================================================

    def init_gripper(self):
        """
        åˆå§‹åŒ–å¤¹çˆªçŠ¶æ€çš„å‡½æ•°
        """
        if self.mc:  # åªæœ‰åœ¨æœºæ¢°è‡‚è¿æ¥æˆåŠŸæ—¶æ‰æ‰§è¡Œ
            try:
                # å°è¯•è®¾ç½®å¤¹çˆªçŠ¶æ€ï¼š
                # å‚æ•°1: 100 è¡¨ç¤ºå®Œå…¨å¼ å¼€ (èŒƒå›´é€šå¸¸ 0-100)
                # å‚æ•°2: 50 è¡¨ç¤ºè¿åŠ¨é€Ÿåº¦
                self.mc.set_gripper_value(100, 50)
                # ç­‰å¾… 1 ç§’è®©å¤¹çˆªå®ŒæˆåŠ¨ä½œ
                time.sleep(1)
            except AttributeError:
                # å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœ pymycobot ç‰ˆæœ¬è¾ƒè€æ²¡æœ‰ set_gripper_value æ–¹æ³•
                # å‚æ•°1: 0 è¡¨ç¤ºå¼ å¼€çŠ¶æ€ (è§†å…·ä½“å›ºä»¶ç‰ˆæœ¬è€Œå®š)
                # å‚æ•°2: 50 è¡¨ç¤ºé€Ÿåº¦
                self.mc.set_gripper_state(0, 50) 
            
            # åˆå§‹åŒ–å®Œæˆåï¼Œé€»è¾‘ä¸Šè®¤ä¸ºæ‰‹é‡Œæ²¡æœ‰ç‰©ä½“
            self.has_object = False

    def go_home(self):
        """
        æ§åˆ¶æœºæ¢°è‡‚å›åˆ°åˆå§‹å§¿æ€ (å…¨é›¶ä½)
        """
        self.get_logger().info("ğŸ  æ­£åœ¨å›åˆ°åˆå§‹ä½ç½® (Home)...")
        if self.mc:  # ç¡®ä¿ç¡¬ä»¶è¿æ¥æ­£å¸¸
            # å‘é€å…³èŠ‚è§’åº¦æŒ‡ä»¤
            # å‚æ•°1: self.home_angles (å³ [0,0,0,0,0,0])
            # å‚æ•°2: 40 (è¿åŠ¨é€Ÿåº¦)
            self.mc.send_angles(self.home_angles, 40)
            # ç­‰å¾… 3 ç§’ï¼Œç»™äºˆè¶³å¤Ÿæ—¶é—´å®Œæˆå½’ä½è¿åŠ¨
            time.sleep(3)

    def move_to_xyz(self, x, y, z):
        """
        æ ¸å¿ƒè¿åŠ¨æ§åˆ¶å‡½æ•°ï¼šæ§åˆ¶æœºæ¢°è‡‚æœ«ç«¯ç§»åŠ¨åˆ°æŒ‡å®šçš„ (x, y, z) åæ ‡
        æ³¨æ„ï¼šè¾“å…¥å•ä½ä¸ºæ¯«ç±³ (mm)
        """
        if not self.mc:
            # å¦‚æœæœºæ¢°è‡‚æœªè¿æ¥ï¼ŒæŠ¥é”™å¹¶è¿”å› False
            self.get_logger().error("æœºæ¢°è‡‚æœªè¿æ¥ï¼Œæ— æ³•ç§»åŠ¨")
            return False

        # å°†ä¼ å…¥çš„åæ ‡èµ‹å€¼ç»™ç›®æ ‡å˜é‡ (ä»£ç ä¸­ä¿ç•™äº†è½¬æ¢é€»è¾‘çš„æ³¨é‡Šï¼Œç¡®è®¤ç›´æ¥ä½¿ç”¨è¾“å…¥å€¼)
        target_x = x
        target_y = y
        target_z = z

        # --- å®‰å…¨èŒƒå›´æ£€æŸ¥ (é€†è¿åŠ¨å­¦è§£ç®—å‰çš„ä¿æŠ¤) ---
        # è®¡ç®—ç›®æ ‡ç‚¹è·ç¦»åº•åº§ä¸­å¿ƒçš„æ¬§å‡ é‡Œå¾—è·ç¦»ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦è¶…å‡ºè‡‚é•¿ã€‚
        distance = math.sqrt(target_x**2 + target_y**2 + (350-target_z)**2)
        
        # è¿™é‡Œçš„ 279 æ˜¯åŸºäº MyCobot 280 è‡‚é•¿è®¾å®šçš„æé™åŠå¾„ (mm)
        if distance > 279: 
            self.get_logger().error(f"âŒ ç›®æ ‡å¤ªè¿œäº† ({distance:.1f}mm)ï¼è¶…å‡ºæœºæ¢°è‡‚æ´»åŠ¨èŒƒå›´ã€‚")
            return False
        # æ£€æŸ¥ Z è½´é«˜åº¦ä¸‹é™ï¼Œé˜²æ­¢æ’å‡»æ¡Œé¢ (å°äº 110mm è§†ä¸ºå±é™©)
        elif target_z < 110:
            self.get_logger().error("âŒ ç›®æ ‡é«˜åº¦è¿‡ä½ï¼è¯·ä¿æŒåœ¨0mmä»¥ä¸Šã€‚")
            return False
        # æ£€æŸ¥ Z è½´é«˜åº¦ä¸Šé™ (å¤§äº 350mm è§†ä¸ºè¶…å‡ºèŒƒå›´)
        elif target_z > 350:
            self.get_logger().error("âŒ ç›®æ ‡é«˜åº¦è¿‡é«˜ï¼è¯·ä¿æŒåœ¨350mmä»¥ä¸‹ã€‚")
            return False

        # æ‰“å°æ—¥å¿—ï¼Œæ˜¾ç¤ºå³å°†æ‰§è¡Œçš„åæ ‡
        self.get_logger().info(f"æ‰§è¡Œç§»åŠ¨ -> x={target_x:.1f}, y={target_y:.1f}, z={target_z:.1f} mm")
        
        # --- è®¾å®šæœ«ç«¯å§¿æ€ ---
        # rx, ry, rz ä»£è¡¨æœ«ç«¯çš„æ—‹è½¬è§’åº¦ (æ¬§æ‹‰è§’)
        # [180, 0, 0] é€šå¸¸è¡¨ç¤ºå¤¹çˆªå‚ç›´å‘ä¸‹ (æœå‘åœ°é¢)
        rx, ry, rz = 180, 0, 0 
        
        # --- å‘é€åæ ‡æŒ‡ä»¤ ---
        # å‚æ•°1: [x, y, z, rx, ry, rz] ç›®æ ‡ä½å§¿åˆ—è¡¨
        # å‚æ•°2: 30 (è¿åŠ¨é€Ÿåº¦)
        # å‚æ•°3: 0 (è¿åŠ¨æ¨¡å¼ï¼Œ0é€šå¸¸ä»£è¡¨çº¿æ€§æ’å€¼æˆ–æ ‡å‡†æ¨¡å¼)
        self.mc.send_coords([target_x, target_y, target_z, rx, ry, rz], 30, 0)
        
        # å¼ºåˆ¶ç­‰å¾… 5 ç§’ï¼Œç¡®ä¿æœºæ¢°è‡‚ç‰©ç†è¿åŠ¨å®Œæˆ (å±äºå¼€ç¯æ§åˆ¶çš„ç®€å•åŒæ­¥æ–¹å¼)
        time.sleep(5) 
        
        # è¿”å› True è¡¨ç¤ºæŒ‡ä»¤å‘é€æˆåŠŸä¸”ç­‰å¾…ç»“æŸ
        return True

    def command_callback(self, msg):
        """
        ROS è¯é¢˜å›è°ƒå‡½æ•°ï¼šå¤„ç†æ”¶åˆ°çš„å­—ç¬¦ä¸²æŒ‡ä»¤
        æŒ‡ä»¤æ ¼å¼ç¤ºä¾‹: "pick 150 0 200" æˆ– "place 150 -100 200"
        """
        # å¦‚æœæœºæ¢°è‡‚æ­£åœ¨æ‰§è¡Œä¸Šä¸€ä¸ªä»»åŠ¡ï¼Œåˆ™å¿½ç•¥æ–°æŒ‡ä»¤å¹¶è­¦å‘Š
        if self.is_busy:
            self.get_logger().warn("â³ å¿™ç¢Œä¸­...")
            return

        # è·å–æ¶ˆæ¯å†…å®¹ï¼Œè½¬ä¸ºå°å†™å¹¶å»é™¤é¦–å°¾ç©ºæ ¼
        command_str = msg.data.lower().strip()
        self.get_logger().info(f"æ”¶åˆ°æŒ‡ä»¤: {command_str}")

        try:
            # å°†æŒ‡ä»¤å­—ç¬¦ä¸²æŒ‰ç©ºæ ¼åˆ†å‰²æˆåˆ—è¡¨
            parts = command_str.split()
            # ç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯æ¨¡å¼ (pick æˆ– place)
            mode = parts[0]
            # åä¸‰ä¸ªéƒ¨åˆ†æ˜¯åæ ‡ï¼Œè½¬æ¢ä¸ºæµ®ç‚¹æ•°
            x = float(parts[1])
            y = float(parts[2])
            z = float(parts[3])

            # æ ‡è®°ç³»ç»Ÿä¸ºå¿™ç¢ŒçŠ¶æ€
            self.is_busy = True
            
            # æ ¹æ®æ¨¡å¼è°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°
            if mode == 'pick':
                self.perform_pick(x, y, z)
            elif mode == 'place':
                self.perform_place(x, y, z)
            else:
                self.get_logger().error("æŒ‡ä»¤é”™è¯¯ï¼šæ— æ³•è¯†åˆ«çš„æ¨¡å¼")

        except Exception as e:
            # æ•è·è§£æé”™è¯¯ (å¦‚å‚æ•°æ•°é‡ä¸å¤Ÿ) æˆ– è½¬æ¢é”™è¯¯
            self.get_logger().error(f"æ‰§è¡Œå‡ºé”™: {e}")
        finally:
            # æ— è®ºæ‰§è¡ŒæˆåŠŸä¸å¦ï¼Œæœ€åéƒ½è§£é™¤å¿™ç¢ŒçŠ¶æ€ï¼Œå…è®¸æ¥æ”¶æ–°æŒ‡ä»¤
            self.is_busy = False

    def perform_pick(self, x, y, z):
        """
        æ‰§è¡ŒæŠ“å–åŠ¨ä½œåºåˆ—
        """
        # é€»è¾‘æ£€æŸ¥ï¼šå¦‚æœå·²ç»æ‹¿ç€ä¸œè¥¿ï¼Œå°±ä¸èƒ½å†æŠ“äº†
        if self.has_object:
            self.get_logger().warn("âš ï¸ æ‰‹é‡Œå·²æœ‰ç‰©ä½“")
            return

        self.get_logger().info(f"--- æ‰§è¡ŒæŠ“å– ---")
        
        # 1. ç§»åŠ¨å‰å…ˆå¼ å¼€å¤¹çˆª (100)
        if self.mc: self.mc.set_gripper_value(100, 50)
        time.sleep(0.5)

        # 2. ç§»åŠ¨åˆ°ç›®æ ‡åæ ‡ (å¦‚æœç§»åŠ¨æˆåŠŸï¼Œåˆ™ç»§ç»­)
        if self.move_to_xyz(x, y, z):
            self.get_logger().info("âœŠ æŠ“å–ä¸­...")
            # 3. é—­åˆå¤¹çˆª (20) - 20 é€šå¸¸è¡¨ç¤ºé—­åˆåˆ°è¾ƒç´§çš„ä½ç½®
            if self.mc: self.mc.set_gripper_value(5, 50)
            time.sleep(1.5) # ç­‰å¾…å¤¹ç´§

            # 4. æŠ“å–åå›åˆ°åˆå§‹ä½ç½® (Home)ï¼Œé˜²æ­¢æ’å‡»
            self.go_home()
            # 5. æ›´æ–°çŠ¶æ€ï¼šæ‰‹é‡Œæœ‰ç‰©ä½“
            self.has_object = True
            self.get_logger().info("âœ… æŠ“å–å®Œæˆ (ç›‘æ§å·²å¼€å¯)")

    def perform_place(self, x, y, z):
        """
        æ‰§è¡Œæ”¾ç½®åŠ¨ä½œåºåˆ—
        """
        # é€»è¾‘æ£€æŸ¥ï¼šå¦‚æœæ‰‹é‡Œæ²¡ä¸œè¥¿ï¼Œå°±ä¸èƒ½æ”¾ç½®
        if not self.has_object:
            self.get_logger().warn("âš ï¸ æ‰‹é‡Œæ²¡ä¸œè¥¿")
            return

        self.get_logger().info(f"--- æ‰§è¡Œæ”¾ç½® ---")

        # 1. ç§»åŠ¨åˆ°ç›®æ ‡æ”¾ç½®åæ ‡
        if self.move_to_xyz(x, y, z):
            self.get_logger().info("ğŸ– æ”¾ä¸‹ä¸­...")
            # 2. å¼ å¼€å¤¹çˆª (100) é‡Šæ”¾ç‰©ä½“
            if self.mc: self.mc.set_gripper_value(100, 50)
            time.sleep(1.5) # ç­‰å¾…å¼ å¼€

            # 3. æ”¾ç½®åå›åˆ°åˆå§‹ä½ç½®
            self.go_home()
            # 4. æ›´æ–°çŠ¶æ€ï¼šæ‰‹é‡Œæ²¡æœ‰ç‰©ä½“
            self.has_object = False
            self.get_logger().info("âœ… æ”¾ç½®å®Œæˆ")

def main(args=None):
    """
    ROS2 èŠ‚ç‚¹çš„å…¥å£å‡½æ•°
    """
    # åˆå§‹åŒ– rclpy åº“
    rclpy.init(args=args)
    # åˆ›å»º ArmWorker èŠ‚ç‚¹å®ä¾‹
    node = ArmWorker()
    try:
        # ä¿æŒèŠ‚ç‚¹è¿è¡Œï¼Œç›‘å¬å›è°ƒï¼Œç›´åˆ°è¢«ä¸­æ–­ (å¦‚ Ctrl+C)
        rclpy.spin(node)
    except KeyboardInterrupt:
        # æ•è·é”®ç›˜ä¸­æ–­ä¿¡å·ï¼Œä¸åšå¤„ç†ï¼Œæ­£å¸¸é€€å‡º
        pass
    finally:
        # é”€æ¯èŠ‚ç‚¹å¯¹è±¡
        node.destroy_node()
        # å…³é—­ rclpy åº“ï¼Œé‡Šæ”¾èµ„æº
        rclpy.shutdown()

# æ ‡å‡†çš„ Python è„šæœ¬å…¥å£åˆ¤æ–­
if __name__ == '__main__':
    main()